<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard ‚Äî BloodLink</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #111827;
      min-height: 100vh;
    }

    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; transition: grid-template-columns 0.25s ease; }
    .sidebar { background: #fff; border-right: 1px solid #e5e7eb; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; position: sticky; top: 0; height: 100vh; transition: width 0.25s ease; }
    .sidebar.collapsed { width: 82px; padding: 1.25rem 0.75rem; }
    body.sidebar-collapsed .layout { grid-template-columns: 82px 1fr; }
    .sidebar.collapsed .logo span:not(.badge),
    .sidebar.collapsed .nav-item span:not(.icon),
    .sidebar.collapsed .sidebar-footer div,
    .sidebar.collapsed .badge { display: none; }
    .sidebar.collapsed .logo { justify-content: center; }
    .sidebar.collapsed .nav-item { justify-content: center; }
    .sidebar.collapsed .sidebar-footer { justify-content: center; }
    .logo { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; color: #b91c1c; }
    .badge { background: #eef2ff; color: #4338ca; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
    .nav { display: flex; flex-direction: column; gap: 0.4rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.9rem; border-radius: 10px; color: #1f2937; text-decoration: none; font-weight: 600; transition: background 0.2s ease, color 0.2s ease; }
    .nav-item .icon { font-size: 1.1rem; }
    .nav-item.active { background: #fef2f2; color: #b91c1c; border: 1px solid #fde8e8; }
    .nav-item:hover { background: #f3f4f6; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem; }
    .avatar { width: 42px; height: 42px; border-radius: 50%; background: #fee2e2; color: #b91c1c; display: flex; align-items: center; justify-content: center; font-weight: 700; }

    .main { padding: 1.5rem 2rem; display: flex; flex-direction: column; gap: 1.25rem; }
    .topbar { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 0.85rem 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; position: sticky; top: 0.75rem; z-index: 5; }
    .search { flex: 1; display: flex; align-items: center; gap: 0.6rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 0.55rem 0.75rem; }
    .search input { border: none; background: transparent; flex: 1; font-size: 0.95rem; outline: none; }
    .top-actions { display: flex; align-items: center; gap: 0.6rem; }
    .icon-btn { width: 38px; height: 38px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; display: grid; place-items: center; cursor: pointer; }
    .pill-btn { background: #b91c1c; color: #fff; border: none; border-radius: 12px; padding: 0.8rem 1.2rem; font-weight: 700; cursor: pointer; box-shadow: 0 8px 18px rgba(185, 28, 28, 0.25); transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .pill-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3); }

    .page-header h1 { margin: 0; font-size: 1.6rem; }
    .page-subtitle { margin: 0.15rem 0 0; color: #6b7280; font-size: 0.98rem; }
    .page { display: none; flex-direction: column; gap: 1rem; }
    .page.active { display: flex; }

    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .stat-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 1rem 1.2rem; display: grid; gap: 0.35rem; box-shadow: 0 8px 16px rgba(0,0,0,0.04); }
    .stat-label { color: #6b7280; font-weight: 600; font-size: 0.9rem; }
    .stat-value { font-size: 2rem; font-weight: 800; }
    .stat-meta { color: #22c55e; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.35rem; }
    .stat-icon { color: #b91c1c; font-size: 1.25rem; }

    .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    .section-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; padding: 1.2rem 1.4rem; box-shadow: 0 8px 16px rgba(0,0,0,0.04); }
    .section-title { margin: 0 0 0.4rem; font-size: 1.05rem; font-weight: 700; }
    .section-sub { margin: 0 0 0.8rem; color: #6b7280; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
    .pill { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.2rem 0.55rem; background: #fef2f2; color: #b91c1c; border-radius: 999px; font-weight: 700; font-size: 0.8rem; }

    .list { display: grid; gap: 0.75rem; }
    .list-item { border: 1px solid #e5e7eb; border-radius: 12px; padding: 0.85rem 1rem; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .list-item .meta { color: #6b7280; font-size: 0.9rem; }
    .actions { display: flex; gap: 0.4rem; }
    .ghost-btn { border: 1px solid #e5e7eb; background: #fff; border-radius: 10px; padding: 0.35rem 0.75rem; font-weight: 700; cursor: pointer; }
    .ghost-btn.danger { border-color: #fca5a5; color: #b91c1c; background: #fef2f2; }

    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 0.9rem; }
    .inventory-card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; background: #fff; display: grid; gap: 0.35rem; position: relative; }
    .blood-type { font-size: 1.4rem; font-weight: 800; color: #b91c1c; }
    .level { font-size: 0.9rem; color: #6b7280; }
    .units { font-size: 1.4rem; font-weight: 800; }
    .units span { font-size: 0.9rem; font-weight: 600; color: #6b7280; }
    .progress { height: 6px; border-radius: 999px; background: #f3f4f6; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #ef4444, #b91c1c); width: 0%; transition: width 0.3s ease; }

    .chart-wrap { padding: 0.4rem 0.2rem 0.8rem; }
    .chart-line { position: relative; height: 180px; }
    .chart-line svg { width: 100%; height: 100%; }
    .chart-tabs { display: inline-flex; gap: 0.4rem; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .chart-tab { padding: 0.35rem 0.75rem; background: #fff; border: none; cursor: pointer; font-weight: 700; color: #6b7280; }
    .chart-tab.active { background: #fef2f2; color: #b91c1c; }

    .placeholder { border: 1px dashed #d1d5db; background: #f9fafb; border-radius: 12px; padding: 1.4rem; color: #6b7280; text-align: center; }

    .events-toolbar { display: flex; gap: 1rem; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .event-search { min-width: 240px; max-width: 520px; width: 100%; }
    .events-list { display: grid; gap: 1rem; }
    .event-card { display: flex; justify-content: space-between; gap: 1rem; padding: 1.2rem 1.4rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 10px 18px rgba(0,0,0,0.03); }
    .event-card h3 { margin: 0 0 0.35rem; color: #0f172a; }
    .event-meta { display: flex; align-items: center; flex-wrap: wrap; gap: 0.75rem; color: #475569; font-weight: 600; }
    .event-meta span { display: inline-flex; align-items: center; gap: 0.35rem; }
    .event-pill { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.2rem 0.65rem; background: #eef2ff; color: #4338ca; border-radius: 999px; font-weight: 700; }
    .event-actions { display: flex; align-items: center; gap: 0.75rem; }
    .event-btn { border: 1px solid #e5e7eb; background: #f8fafc; border-radius: 10px; padding: 0.55rem 0.9rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; }
    .event-btn.primary { background: #111827; color: #fff; border-color: #111827; }

    .modal { position: fixed; inset: 0; background: rgba(15,23,42,0.4); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
    .modal.active { display: flex; }
    .modal-card { width: min(960px, 96vw); background: #fff; border-radius: 14px; box-shadow: 0 25px 60px rgba(0,0,0,0.18); border: 1px solid #e5e7eb; }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .modal-body { padding: 1rem 1.25rem; max-height: 70vh; overflow-y: auto; }
    .modal-actions { padding: 0.75rem 1.25rem 1rem; display: flex; justify-content: flex-end; gap: 0.6rem; border-top: 1px solid #e5e7eb; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { text-align: left; padding: 0.65rem 0.5rem; border-bottom: 1px solid #e5e7eb; }
    .table th { background: #f8fafc; font-weight: 700; color: #1f2937; }
    .badge-soft { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.6rem; border-radius: 999px; font-weight: 700; font-size: 0.85rem; }
    .badge-soft.green { background: #ecfdf3; color: #16a34a; border: 1px solid #bbf7d0; }
    .badge-soft.orange { background: #fff7ed; color: #f97316; border: 1px solid #fed7aa; }
    .badge-soft.gray { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .form-grid { display: grid; gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .form-field { display: flex; flex-direction: column; gap: 0.35rem; }
    .form-field label { font-weight: 700; color: #111827; }
    .form-field input, .form-field textarea { padding: 0.55rem 0.7rem; border-radius: 10px; border: 1px solid #e5e7eb; background: #f9fafb; font-family: inherit; }
    .form-field textarea { min-height: 90px; resize: vertical; }
    .empty { border: 1px dashed #cbd5e1; padding: 1rem; border-radius: 12px; background: #f8fafc; color: #475569; text-align: center; font-weight: 600; }

    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; flex-direction: row; flex-wrap: wrap; gap: 0.6rem; } .sidebar-footer { width: 100%; } }
    @media (max-width: 768px) { .topbar { flex-direction: column; align-items: stretch; } .top-actions { width: 100%; justify-content: space-between; } .search { width: 100%; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">ü©∏ BloodLink <span class="badge">Blood Bank</span></div>
      <nav class="nav">
        <a class="nav-item active" data-page="dashboard"><span class="icon">üè†</span> Dashboard</a>
        <a class="nav-item" href="../pages/donor-management.html"><span class="icon">üë•</span> Donor Mgmt</a>
        <a class="nav-item" href="../shared-pages/event-management.html"><span class="icon">üìÖ</span> Events</a>
        <a class="nav-item" href="../donation-recording.html"><span class="icon">ü©∏</span> Record Donation</a>
        <a class="nav-item" href="../shared-pages/inventory-management.html"><span class="icon">üì¶</span> Inventory</a>
        <a class="nav-item" href="../pages/request-management.html"><span class="icon">üè•</span> Requests</a>
        <a class="nav-item" href="../shared-pages/emergency-requests.html"><span class="icon">üö®</span> Emergency</a>
        <a class="nav-item" href="../shared-pages/reports.html"><span class="icon">üìä</span> Reports</a>
        <a class="nav-item" href="pages/staff-profile.html"><span class="icon">üë§</span> Profile</a>
        <a class="nav-item" href="../shared-pages/audit-logs.html"><span class="icon">üîê</span> Audit Logs</a>
      </nav>
      <div class="sidebar-footer">
        <div class="avatar" id="userInitial">S</div>
        <div>
          <div id="userName">Staff</div>
          <small style="color:#6b7280;">Staff Account</small>
        </div>
        <button class="icon-btn" onclick="logout()" title="Logout">‚á¶</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <span>üîç</span>
          <input type="text" placeholder="Search requests, donors, inventory..." aria-label="Search" />
        </div>
        <div class="top-actions">
          <button class="icon-btn" id="sidebarToggle" title="Toggle sidebar">‚ò∞</button>
          <button class="icon-btn" title="Notifications">üîî</button>
          <button class="icon-btn" title="Toggle theme">üåô</button>
          <button class="pill-btn" onclick="fulfillNow()">Fulfill Request</button>
        </div>
      </div>

      <section id="dashboardPage" class="page active">
        <div class="page-header">
          <h1>Blood Bank Dashboard</h1>
          <p class="page-subtitle">Monitor requests, inventory, and collection performance.</p>
        </div>

        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">TOTAL INVENTORY</div>
            <div class="stat-value" id="stat-inventory">0</div>
            <div class="stat-meta"><span class="stat-icon">ü©∏</span>ml in storage</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">FULFILLED</div>
            <div class="stat-value" id="stat-fulfilled">0</div>
            <div class="stat-meta" id="stat-fulfilled-meta">Completed requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">PENDING</div>
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-meta" style="color:#f97316"><span class="stat-icon">‚è≥</span>Awaiting action</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">RECENT COLLECTIONS</div>
            <div class="stat-value" id="stat-collections">0</div>
            <div class="stat-meta" style="color:#0ea5e9"><span class="stat-icon">üóìÔ∏è</span>Past 30 days</div>
          </div>
        </div>

        <div class="two-col">
          <div class="section-card">
            <div class="section-title">Urgent Requests</div>
            <div class="section-sub">
              <span>Prioritize high-severity needs</span>
              <button class="ghost-btn">View All</button>
            </div>
            <div class="list" id="urgentList"></div>
          </div>

          <div class="section-card">
            <div class="section-title">Upcoming Events</div>
            <div class="section-sub">
              <span>Coordinate drives and outreach</span>
              <button class="pill-btn" style="padding:0.55rem 0.9rem; box-shadow:none;" onclick="addEvent()">Add Event</button>
            </div>
            <div class="list" id="eventList"></div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title">Donation Statistics</div>
          <div class="section-sub">
            <span>Daily performance</span>
            <div class="chart-tabs">
              <button class="chart-tab active" data-range="daily">Daily</button>
              <button class="chart-tab" data-range="weekly">Weekly</button>
              <button class="chart-tab" data-range="monthly">Monthly</button>
            </div>
          </div>
          <div class="chart-wrap">
            <div class="chart-line">
              <svg id="statsChart" preserveAspectRatio="none"></svg>
            </div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title">Available Blood Inventory</div>
          <p class="section-sub">Live stock by blood type</p>
          <div class="inventory-grid" id="inventoryGrid"></div>
        </div>
      </section>

      <section id="inventoryPage" class="page">
        <div class="page-header">
          <h1>Inventory</h1>
          <p class="page-subtitle">Detailed inventory controls (coming soon).</p>
        </div>
        <div class="placeholder">Inventory management coming soon.</div>
      </section>

      <section id="fulfillPage" class="page">
        <div class="page-header">
          <h1>Fulfill Requests</h1>
          <p class="page-subtitle">Assign and complete blood requests.</p>
        </div>
        <div class="placeholder">Fulfillment workflow coming soon.</div>
      </section>

      <section id="eventsPage" class="page">
        <div class="page-header">
          <h1>Events</h1>
          <p class="page-subtitle">Plan and track blood drives.</p>
        </div>
        <div class="events-toolbar">
          <div class="search event-search">
            <span>üîç</span>
            <input id="eventSearch" type="text" placeholder="Search donors, hospitals, requests..." aria-label="Search events" />
          </div>
          <button class="pill-btn" onclick="openAddEvent()">+ Add Event</button>
        </div>
        <div class="events-list" id="eventsList"></div>
      </section>
    </main>
  </div>

  <div class="modal" id="participantsModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="section-title" id="participantsTitle">Event Participants</div>
          <div class="section-sub" id="participantsMeta">Attendees</div>
        </div>
        <button class="ghost-btn" onclick="closeModal('participantsModal')">Close</button>
      </div>
      <div class="modal-body" id="participantsBody"></div>
      <div class="modal-actions">
        <button class="ghost-btn" onclick="closeModal('participantsModal')">Done</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addEventModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="section-title">Create Event</div>
          <div class="section-sub">Share details so donors can sign up.</div>
        </div>
        <button class="ghost-btn" onclick="closeModal('addEventModal')">Cancel</button>
      </div>
      <form id="addEventForm">
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-field">
              <label for="eventTitle">Title</label>
              <input id="eventTitle" name="title" type="text" placeholder="Blood Donation Camp" required />
            </div>
            <div class="form-field">
              <label for="eventDate">Date</label>
              <input id="eventDate" name="date" type="date" required />
            </div>
            <div class="form-field">
              <label for="startTime">Start Time</label>
              <input id="startTime" name="startTime" type="time" required />
            </div>
            <div class="form-field">
              <label for="endTime">End Time</label>
              <input id="endTime" name="endTime" type="time" required />
            </div>
            <div class="form-field">
              <label for="eventLocation">Location</label>
              <input id="eventLocation" name="location" type="text" placeholder="City Central Park" required />
            </div>
            <div class="form-field">
              <label for="expectedCount">Expected Donors</label>
              <input id="expectedCount" name="expected" type="number" min="1" placeholder="120" required />
            </div>
          </div>
          <div class="form-field" style="margin-top:0.5rem;">
            <label for="eventNotes">Notes (optional)</label>
            <textarea id="eventNotes" name="notes" placeholder="Parking info, pre-screening reminders, directions..."></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="ghost-btn" onclick="closeModal('addEventModal')">Cancel</button>
          <button type="submit" class="pill-btn">Create Event</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let events = [];

    function getAuth() {
      const token = localStorage.getItem('token');
      const staffId = localStorage.getItem('staffId');
      if (!token || !staffId) {
        window.location.href = 'login-staff.html';
        return null;
      }
      return { token, staffId };
    }

    function setUser(profile) {
      const name = profile?.full_name || localStorage.getItem('userName') || 'Staff';
      document.getElementById('userName').textContent = name;
      document.getElementById('userInitial').textContent = name.charAt(0).toUpperCase();
    }

    function classifyLevel(amount) {
      if (amount >= 160) return { label: 'Full', tone: '#16a34a' };
      if (amount >= 110) return { label: 'Medium', tone: '#f59e0b' };
      if (amount >= 60) return { label: 'Low', tone: '#f97316' };
      return { label: 'Critical', tone: '#ef4444' };
    }

    function renderInventory(inventoryByType = {}) {
      const order = ['A+','A-','B+','B-','AB+','AB-','O+','O-'];
      const container = document.getElementById('inventoryGrid');
      const capacity = 200;
      const cards = order.map(type => {
        const data = inventoryByType[type] || { total: 0, expiring: 0 };
        const pct = Math.min(100, Math.round((data.total / capacity) * 100));
        const level = classifyLevel(data.total);
        const expiringBadge = data.expiring > 0 ? `<span class="pill">‚è∞ ${data.expiring} expiring</span>` : '';
        return `
          <div class="inventory-card">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div>
                <div class="blood-type">${type}</div>
                <div class="level" style="color:${level.tone};">${level.label}</div>
              </div>
              ${expiringBadge}
            </div>
            <div class="units">${data.total}<span> units</span></div>
            <div class="progress"><div class="progress-bar" style="width:${pct}%;"></div></div>
            <div class="level" style="margin-top:0.2rem;">${pct}% of capacity</div>
          </div>`;
      }).join('');
      container.innerHTML = cards;
    }

    function renderStats(stats) {
      const inventory = stats.totalInventoryMl || 0;
      const fulfilled = stats.fulfilledRequests || 0;
      const pending = stats.pendingRequests || 0;
      const cancelled = stats.cancelledRequests || 0;
      const collections = stats.recentCollections || 0;
      document.getElementById('stat-inventory').textContent = inventory;
      document.getElementById('stat-fulfilled').textContent = fulfilled;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-collections').textContent = collections;
      document.getElementById('stat-fulfilled-meta').textContent = `${cancelled} cancelled`;
      renderInventory(stats.inventoryByType || {});
    }

    function renderUrgentList() {
      const urgentList = document.getElementById('urgentList');
      const urgent = [
        { name:'City General Hospital', units:8, ago:'2 hours ago', blood:'O-', severity:'High' },
        { name:'St. Mary Medical Center', units:4, ago:'3 hours ago', blood:'AB+', severity:'High' },
        { name:'Regional Health', units:6, ago:'5 hours ago', blood:'A+', severity:'Medium' }
      ];
      urgentList.innerHTML = urgent.map(item => `
        <div class="list-item">
          <div>
            <div style="font-weight:700;">${item.name}</div>
            <div class="meta">${item.blood} ‚Ä¢ ${item.units} units ‚Ä¢ ${item.ago}</div>
          </div>
          <div class="actions">
            <span class="pill" style="background:${item.severity==='High'?'#fee2e2':'#fef9c3'}; color:${item.severity==='High'?'#b91c1c':'#b45309'};">${item.severity}</span>
            <button class="ghost-btn danger" onclick="fulfillNow()">Fulfill</button>
          </div>
        </div>`).join('');
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function normalizeEvent(ev) {
      if (!ev) return null;
      return {
        id: ev._id || ev.id,
        title: ev.title,
        date: ev.date ? ev.date.slice(0, 10) : ev.date,
        start: ev.start_time || ev.startTime,
        end: ev.end_time || ev.endTime,
        location: ev.location,
        expected: ev.expected,
        notes: ev.notes,
        participants: ev.participants || []
      };
    }

    async function fetchEvents() {
      const auth = getAuth();
      if (!auth) return;
      try {
        const res = await fetch('/api/events', { headers: { 'Authorization': `Bearer ${auth.token}` } });
        if (!res.ok) throw new Error('Failed to load events');
        const payload = await res.json();
        events = (payload.data || []).map(normalizeEvent).filter(Boolean);
        renderDashboardEvents();
        renderEventsPage(document.getElementById('eventSearch')?.value || '');
      } catch (err) {
        console.error('Could not fetch events', err);
      }
    }

    async function createEvent(body) {
      const auth = getAuth();
      if (!auth) return;
      const submitBtn = document.querySelector('#addEventForm button[type="submit"]');
      if (submitBtn) submitBtn.disabled = true;
      try {
        const res = await fetch('/api/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${auth.token}`
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const errMsg = await res.text();
          throw new Error(errMsg || 'Failed to create event');
        }
        await fetchEvents();
        closeModal('addEventModal');
      } catch (err) {
        console.error('Create event failed', err);
        alert('Unable to create event right now. Please try again.');
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    }

    function renderDashboardEvents() {
      const eventList = document.getElementById('eventList');
      if (!eventList) return;
      const nextEvents = [...events].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 3);
      eventList.innerHTML = nextEvents.map(ev => {
        const when = `${formatDate(ev.date)} ‚Ä¢ ${ev.start || 'TBD'} - ${ev.end || 'TBD'}`;
        const expected = ev.expected ? `${ev.expected} expected donors` : 'Signups open';
        return `
          <div class="list-item">
            <div>
              <div style="font-weight:700;">${ev.title}</div>
              <div class="meta">üìÖ ${when}</div>
              <div class="meta">üìç ${ev.location}</div>
              <div class="meta">üë• ${expected}</div>
            </div>
            <button class="ghost-btn" onclick="openParticipants('${ev.id}')">Check</button>
          </div>`;
      }).join('');
    }

    function renderEventsPage(filterTerm = '') {
      const list = document.getElementById('eventsList');
      if (!list) return;
      const term = filterTerm.trim().toLowerCase();
      const filtered = events
        .filter(ev => ev.title.toLowerCase().includes(term) || ev.location.toLowerCase().includes(term))
        .sort((a,b) => new Date(a.date) - new Date(b.date));
      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty">No events match that search.</div>';
        return;
      }
      list.innerHTML = filtered.map(ev => {
        const when = `${formatDate(ev.date)} ‚Ä¢ ${ev.start || 'TBD'} - ${ev.end || 'TBD'}`;
        const expected = ev.expected ? `${ev.expected} expected donors` : 'Signups open';
        const note = ev.notes ? `<div class="meta" style="margin-top:0.35rem;">üìù ${ev.notes}</div>` : '';
        return `
          <div class="event-card">
            <div>
              <h3>${ev.title}</h3>
              <div class="event-meta">
                <span>üìÖ ${when}</span>
                <span>üìç ${ev.location}</span>
                <span class="event-pill">üë• ${expected}</span>
              </div>
              ${note}
            </div>
            <div class="event-actions">
              <button class="event-btn" onclick="openParticipants('${ev.id}')">üëÅÔ∏è Check Participants</button>
            </div>
          </div>`;
      }).join('');
    }

    function openParticipants(eventId) {
      const event = events.find(ev => ev.id === eventId);
      const participants = event?.participants || [];
      const titleEl = document.getElementById('participantsTitle');
      const metaEl = document.getElementById('participantsMeta');
      const bodyEl = document.getElementById('participantsBody');
      if (!event || !titleEl || !metaEl || !bodyEl) return;
      titleEl.textContent = event.title;
      metaEl.textContent = `${formatDate(event.date)} ‚Ä¢ ${event.start} - ${event.end} ‚Ä¢ ${event.location}`;
      if (participants.length === 0) {
        bodyEl.innerHTML = '<div class="empty">No participants have signed up yet.</div>';
      } else {
        bodyEl.innerHTML = `
          <table class="table">
            <thead>
              <tr><th>Name</th><th>Blood Type</th><th>Status</th><th>Registered</th></tr>
            </thead>
            <tbody>
              ${participants.map(p => {
                const tone = p.status === 'Confirmed' ? 'green' : p.status === 'Tentative' ? 'orange' : 'gray';
                return `<tr>
                  <td>${p.name}</td>
                  <td>${p.blood}</td>
                  <td><span class="badge-soft ${tone}">${p.status}</span></td>
                  <td>${formatDate(p.registered)}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>`;
      }
      document.getElementById('participantsModal').classList.add('active');
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('active');
    }

    function openAddEvent() {
      document.getElementById('addEventForm').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('eventDate').value = today;
      document.getElementById('addEventModal').classList.add('active');
    }

    function handleAddEventSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const title = form.title.value.trim();
      const date = form.date.value;
      const startTime = form.startTime.value;
      const endTime = form.endTime.value;
      const location = form.location.value.trim();
      const expected = parseInt(form.expected.value, 10) || null;
      const notes = form.notes.value.trim();
      if (!title || !date || !startTime || !endTime || !location) return;
      createEvent({ title, date, start_time: startTime, end_time: endTime, location, expected, notes });
    }

    function drawChart(range='daily') {
      const svg = document.getElementById('statsChart');
      const datasets = {
        daily: [45,52,38,60,48,72,55],
        weekly: [220,245,210,260,275,240,255],
        monthly: [900,880,940,980,1020,990,1010]
      };
      const data = datasets[range] || [];
      const max = Math.max(...data, 80);
      const stepX = 100 / (data.length - 1 || 1);
      const pts = data.map((v,i) => {
        const x = i * stepX;
        const y = 100 - (v / max * 100);
        return `${x},${y}`;
      }).join(' ');
      svg.innerHTML = `
        <polyline points="${pts}" fill="none" stroke="#b91c1c" stroke-width="2.5" />
        ${pts.split(' ').map(p => {
          const [x,y] = p.split(',');
          return `<circle cx="${x}" cy="${y}" r="3.5" fill="#ef4444" stroke="#fff" stroke-width="1.5" />`;
        }).join('')}
      `;
    }

    async function loadDashboard() {
      const auth = getAuth();
      if (!auth) return;
      try {
        const [profileRes, statsRes] = await Promise.all([
          fetch(`/api/staff/profile/${auth.staffId}`, { headers: { 'Authorization': `Bearer ${auth.token}` } }),
          fetch(`/api/dashboard/stats/staff/${auth.staffId}`, { headers: { 'Authorization': `Bearer ${auth.token}` } })
        ]);

        if (profileRes.ok) {
          const profile = await profileRes.json();
          setUser(profile.data);
        }
        if (statsRes.ok) {
          const stats = await statsRes.json();
          renderStats(stats.data || {});
        }
      } catch (err) {
        console.error('Dashboard load failed', err);
      }
    }

    function setupNav() {
      const pages = {
        dashboard: document.getElementById('dashboardPage'),
        inventory: document.getElementById('inventoryPage'),
        fulfill: document.getElementById('fulfillPage'),
        events: document.getElementById('eventsPage')
      };
      document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
          const page = item.dataset.page;
          Object.keys(pages).forEach(key => pages[key].classList.toggle('active', key === page));
        });
      });
    }

    function setupChartTabs() {
      document.querySelectorAll('.chart-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          drawChart(btn.dataset.range);
        });
      });
    }

    function fulfillNow() { alert('Fulfillment workflow coming soon.'); }
    function addEvent() { openAddEvent(); }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('userType');
      localStorage.removeItem('staffId');
      localStorage.removeItem('userName');
      window.location.href = 'login-staff.html';
    }

    function setupSidebarToggle() {
      const sidebar = document.querySelector('.sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      if (!sidebar || !toggleBtn) return;

      const applyState = (collapsed) => {
        sidebar.classList.toggle('collapsed', collapsed);
        document.body.classList.toggle('sidebar-collapsed', collapsed);
      };

      const saved = localStorage.getItem('staffSidebarCollapsed') === 'true';
      applyState(saved);

      toggleBtn.addEventListener('click', () => {
        const next = !sidebar.classList.contains('collapsed');
        applyState(next);
        localStorage.setItem('staffSidebarCollapsed', String(next));
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupSidebarToggle();
      setupNav();
      setupChartTabs();
      renderUrgentList();
      fetchEvents();
      drawChart('daily');
      loadDashboard();
      const searchInput = document.getElementById('eventSearch');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => renderEventsPage(e.target.value));
      }
      const addEventForm = document.getElementById('addEventForm');
      if (addEventForm) {
        addEventForm.addEventListener('submit', handleAddEventSubmit);
      }
    });
  </script>
</body>
</html>
