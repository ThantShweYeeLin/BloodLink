<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Profile ‚Äî Life Link</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #111827; display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        .sidebar { background: #fff; border-right: 1px solid #e5e7eb; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .sidebar-logo { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; color: #b91c1c; margin-bottom: 1rem; }
    .nav { display: flex; flex-direction: column; gap: 0.4rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.9rem; border-radius: 10px; color: #1f2937; text-decoration: none; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
    .nav-item:hover { background: #f3f4f6; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem; }
    .user-avatar { width: 42px; height: 42px; border-radius: 50%; background: #fee2e2; color: #b91c1c; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-email { font-size: 0.9rem; font-weight: 600; color: #1f2937; }
    .user-role { font-size: 0.8rem; color: #6b7280; }
    .logout-icon { cursor: pointer; font-size: 1.2rem; }
    .main-content { padding: 1.5rem 2rem; display: flex; flex-direction: column; gap: 1.25rem; overflow-y: auto; }
    .container { width: 100%; }
    .header { background: #b91c1c; color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    @media (max-width: 1024px) { body { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; } }
    @media (max-width: 768px) { .main-content { padding: 1rem; } .header { flex-direction: column; text-align: center; } }
    .profile-card { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .profile-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #f3f4f6; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: 700; box-shadow: 0 4px 12px rgba(185, 28, 28, 0.3); }
    .profile-info { flex: 1; }
    .profile-info h2 { margin: 0 0 0.5rem; font-size: 1.8rem; color: #111827; }
    .profile-info p { color: #6b7280; margin: 0.3rem 0; font-size: 0.95rem; }
    .profile-info .role { font-size: 1.1rem; font-weight: 600; color: #b91c1c; display: inline-flex; align-items: center; gap: 0.5rem; background: #fee2e2; padding: 0.4rem 1rem; border-radius: 20px; margin-bottom: 0.5rem; }
    .profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem; }
    .stat-box { background: #f9fafb; padding: 1rem; border-radius: 8px; text-align: center; border-left: 3px solid #b91c1c; }
    .stat-box .number { font-size: 1.8rem; font-weight: 700; color: #b91c1c; }
    .stat-box .label { font-size: 0.85rem; color: #6b7280; margin-top: 0.3rem; }
    .section { margin-bottom: 2rem; }
    .section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: #111827; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f3f4f6; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
    .info-item { background: #f9fafb; padding: 1.2rem; border-radius: 8px; border-left: 3px solid #e5e7eb; transition: all 0.2s; }
    .info-item:hover { border-left-color: #b91c1c; transform: translateX(2px); }
    .info-label { color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value { font-weight: 600; font-size: 1.05rem; color: #111827; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; }
    input:focus, select:focus { outline: none; border-color: #b91c1c; box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); background: #fff; }
    .btn { background: #b91c1c; color: white; border: none; padding: 0.85rem 1.8rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 0.5rem; transition: all 0.2s; font-size: 0.95rem; }
    .btn:hover { background: #a01818; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(185, 28, 28, 0.3); }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { background: #4b5563; transform: translateY(-1px); }
    .btn-danger { background: #dc2626; }
    .btn-danger:hover { background: #b91c1c; transform: translateY(-1px); }
    .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .event-tag { display: inline-block; background: #dbeafe; color: #1e40af; padding: 0.3rem 0.7rem; border-radius: 999px; margin: 0.2rem; font-size: 0.85rem; }
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #86efac; }
    .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; }
    .modal-header { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; }
    .modal-footer { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; }
    .table-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f3f4f6; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
    td { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    tr:hover { background: #f9fafb; }
    .badge { display: inline-block; padding: 0.3rem 0.7rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: #d1fae5; color: #065f46; }
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .spinner { border: 3px solid #e5e7eb; border-top: 3px solid #b91c1c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <link rel="stylesheet" href="../../shared-pages/sidebar-toggle.css" />
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-logo">ü©∏ Life Link</div>
    <nav class="nav">
      <a href="../dashboard.html" class="nav-item">üè† Dashboard</a>
      <a href="./donor-management.html" class="nav-item">üë• Donor Mgmt</a>
      <a href="./event-management.html" class="nav-item">üìÖ Events</a>
      <a href="../donation-recording.html" class="nav-item">ü©∏ Record Donation</a>
      <a href="./inventory-management.html" class="nav-item">üì¶ Inventory</a>
      <a href="./request-management.html" class="nav-item">üè• Requests</a>
      <a href="./emergency-requests.html" class="nav-item">üö® Emergency</a>
      <a href="./reports.html" class="nav-item">üìä Reports</a>
      <a href="./staff-profile.html" class="nav-item">üë§ Profile</a>
      <a href="./audit-logs.html" class="nav-item">üîê Audit Logs</a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-avatar" id="userInitial">S</div>
      <div class="user-info">
        <div class="user-email" id="userName">Staff</div>
        <div class="user-role">Staff Account</div>
      </div>
      <div class="logout-icon" onclick="logout()" title="Logout">‚á¶</div>
    </div>
  </aside>
  <main class="main-content">
  <div class="container">
    <div class="header">
      <h1>üë§ Staff Profile</h1>
      </div>

    <div id="alertContainer"></div>

    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar" id="avatar">üë§</div>
        <div class="profile-info">
          <h2 id="staffName">Loading...</h2>
          <div class="role" id="staffRole">üìã Staff Member</div>
          <p>üìß <span id="staffEmail">-</span></p>
          <p>üì± <span id="staffPhone">-</span></p>
          <div class="profile-stats">
            <div class="stat-box">
              <div class="number" id="eventsCount">0</div>
              <div class="label">Events Managed</div>
            </div>
            <div class="stat-box">
              <div class="number" id="donationsCount">0</div>
              <div class="label">Donations Recorded</div>
            </div>
            <div class="stat-box">
              <div class="number" id="yearsService">0</div>
              <div class="label">Years of Service</div>
            </div>
          </div>‚úèÔ∏è 
        </div>
      </div>

      <div class="section">
        <div class="section-title">üìã Personal Information</div>
        <div class="info-grid" id="personalInfo">
          <div class="loading"><div class="spinner"></div>Loading profile...</div>
        </div>
      </div>
    </div>

    <div class="profile-card">
      <div class="section">
        <div class="section-title">Edit Profile</div>
        <form id="editForm" onsubmit="saveProfile(event)">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="fullName" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="phone">
          </div>
          <div class="form-group">
            <label>Department</label>
            <input type="text" id="department">
          </div>
          <div class="button-group">
            <button type="submit" class="btn">Save Changes</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Discard</button>
          </div>
        </form>
      </div>
    </div>

    <div class="profile-card">
      <div class="section">
        <div class="section-title">üîí Change Password</div>
        <form id="passwordForm" onsubmit="changePassword(event)">
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" required>
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" required minlength="8">
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmPassword" required minlength="8">
          </div>
          <div class="button-group">
            <button type="submit" class="btn">Update Password</button>
            <button type="button" class="btn btn-secondary" onclick="resetPasswordForm()">Clear</button>
          </div>
        </form>
      </div>
    </div>

    <div class="profile-card">
      <div class="section">
        <div class="section-title">üìÖ Assigned Events</div>
        <div class="table-card">
          <table>
            <thead>
              <tr>
                <th>Event Name</th>
                <th>Date</th>
                <th>Location</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="eventsTable">
              <tr><td colspan="4" class="loading"><div class="spinner"></div>Loading events...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  </main>

  <script src="../../shared-pages/api-base.js"></script>
  <script>
      const API_BASE = window.LIFELINK_API_BASE || 'http://localhost:3000';
    const API_URL = `${API_BASE}/api`;
    const REQUEST_TIMEOUT_MS = 15000;
    let currentStaffData = null;

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '../login-staff.html';
        return false;
      }
      return true;
    }

    function getAuthHeader() {
      return {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      };
    }

    async function apiCall(endpoint, method = 'GET', body = null, retries = 1) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
      try {
        const options = { method, headers: getAuthHeader(), signal: controller.signal };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(`${API_URL}${endpoint}`, options);
        clearTimeout(timeoutId);
        let data;
        try {
          data = await response.json();
        } catch (e) {
          data = { success: false, message: 'Invalid server response' };
        }
        if (response.status === 401) {
          localStorage.clear();
          window.location.href = '../login-staff.html';
          return { success: false, message: 'Unauthorized' };
        }
        if (!response.ok) {
          return { success: false, message: data.message || 'Request failed' };
        }
        return data;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError' && retries > 0) {
          return apiCall(endpoint, method, body, retries - 1);
        }
        if (error.name === 'AbortError') {
          return { success: false, message: 'Request timed out' };
        }
        console.error('API Error:', error);
        return { success: false, message: 'Network error' };
      }
    }

    async function loadProfile() {
      const staffId = localStorage.getItem('staffId') || localStorage.getItem('userId');
      if (!staffId) {
        showAlert('Missing staff ID. Please log in again.', 'error');
        return;
      }

      let data = await apiCall(`/staff/profile/${staffId}`);

      if (!data.success) {
        const cached = localStorage.getItem('cachedStaffProfile');
        if (cached) {
          data = { success: true, data: JSON.parse(cached) };
          showAlert('Showing cached profile data. Refresh to try again.', 'error');
        } else {
          showAlert(data.message || 'Failed to load profile', 'error');
          return;
        }
      }

      currentStaffData = data.data;
      localStorage.setItem('cachedStaffProfile', JSON.stringify(data.data));

      // Update header
      const initial = (data.data.full_name || 'S').charAt(0).toUpperCase();
      document.getElementById('avatar').textContent = initial;
      document.getElementById('staffName').textContent = data.data.full_name || 'Staff Member';
      document.getElementById('staffRole').textContent = `üìã ${data.data.role || 'Staff Member'}`;
      document.getElementById('staffEmail').textContent = data.data.email || 'Not provided';
      document.getElementById('staffPhone').textContent = data.data.phone || 'Not provided';

      // Calculate years of service
      const joinDate = data.data.registration_date ? new Date(data.data.registration_date) : new Date();
      const years = ((new Date() - joinDate) / (1000 * 60 * 60 * 24 * 365)).toFixed(1);
      document.getElementById('yearsService').textContent = years;

      // Update form
      document.getElementById('fullName').value = data.data.full_name || '';
      document.getElementById('email').value = data.data.email || '';
      document.getElementById('phone').value = data.data.phone || '';
      document.getElementById('department').value = data.data.department || '';

      // Display personal info
      const infoHtml = `
        <div class="info-item">
          <div class="info-label">Staff ID</div>
          <div class="info-value">#${String(data.data.id).padStart(4, '0')}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Role</div>
          <div class="info-value">${data.data.role || 'Staff Member'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Department</div>
          <div class="info-value">${data.data.department || 'Not Assigned'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Email Address</div>
          <div class="info-value">${data.data.email || 'Not provided'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Phone Number</div>
          <div class="info-value">${data.data.phone || 'Not provided'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Address</div>
          <div class="info-value">${data.data.address || 'Not provided'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Joined</div>
          <div class="info-value">${data.data.registration_date ? new Date(data.data.registration_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not available'}</div>
        </div>
      `;
      document.getElementById('personalInfo').innerHTML = infoHtml;

      loadAssignedEvents();
    }

    async function loadAssignedEvents() {
      // Fallback to all events if staff-specific endpoint is unavailable
      const events = await apiCall('/events');
      if (!events.success) {
        document.getElementById('eventsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #9ca3af;">Unable to load events</td></tr>';
        return;
      }

      const staffId = localStorage.getItem('staffId');
      const staffEvents = (events.data || []).filter(e => !e.assigned_staff_id || String(e.assigned_staff_id) === staffId);
      document.getElementById('eventsCount').textContent = staffEvents.length;

      const html = staffEvents.map(e => {
        const isUpcoming = new Date(e.event_date) > new Date();
        const badgeClass = 'badge';
        const status = isUpcoming ? 'Upcoming' : 'Completed';
        return `
          <tr>
            <td><strong>${e.event_name}</strong></td>
            <td>${e.event_date ? new Date(e.event_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '‚Äî'}</td>
            <td>${e.location || 'TBD'}</td>
            <td><span class="${badgeClass}">${status}</span></td>
          </tr>
        `;
      }).join('');

      document.getElementById('eventsTable').innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #9ca3af;">No events assigned</td></tr>';
    }

    async function saveProfile(e) {
      e.preventDefault();

      const staffId = localStorage.getItem('staffId');
      const data = {
        full_name: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        department: document.getElementById('department').value
      };

      const result = await apiCall(`/staff/${staffId}`, 'PUT', data);

      if (result.success) {
        showAlert('Profile updated successfully', 'success');
        currentStaffData = { ...currentStaffData, ...data };
        document.getElementById('staffName').textContent = data.full_name;
      } else {
        showAlert(result.message || 'Failed to update profile', 'error');
      }
    }

    function resetForm() {
      document.getElementById('fullName').value = currentStaffData.full_name || '';
      document.getElementById('email').value = currentStaffData.email || '';
      document.getElementById('phone').value = currentStaffData.phone || '';
      document.getElementById('department').value = currentStaffData.department || '';
    }

    async function changePassword(e) {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        return showAlert('Passwords do not match', 'error');
      }

      const staffId = localStorage.getItem('staffId');
      const result = await apiCall(`/staff/${staffId}/password`, 'PUT', {
        current_password: document.getElementById('currentPassword').value,
        new_password: newPassword
      });

      if (result.success) {
        showAlert('Password changed successfully', 'success');
        resetPasswordForm();
      } else {
        showAlert(result.message || 'Failed to change password', 'error');
      }
    }

    function resetPasswordForm() {
      document.getElementById('passwordForm').reset();
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
      const icon = type === 'success' ? '‚úì' : '‚úó';
      container.innerHTML = `<div class="alert ${alertClass}">${icon} ${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../login-staff.html';
    }

    if (checkAuth()) {
      loadProfile();
    }
  </script>
  <script type="module" src="../../shared-pages/sidebar-toggle.js"></script>
</body>
</html>
