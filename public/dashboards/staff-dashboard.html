<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staff Dashboard ‚Äî Life Link</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #111827; }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; transition: grid-template-columns 0.3s ease; }
    .layout.sidebar-collapsed { grid-template-columns: 80px 1fr; }
    .sidebar { background: #ffffff; border-right: 1px solid #e5e7eb; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.4rem; position: sticky; top: 0; height: 100vh; transition: all 0.3s ease; width: 260px; overflow: hidden; }
    .sidebar-collapsed .sidebar { width: 80px; padding: 1.5rem 0.5rem; }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .logo { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; color: #b91c1c; }
    .toggle-btn { background: #f3f4f6; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; flex-shrink: 0; }
    .toggle-btn:hover { background: #e5e7eb; }
    .sidebar-collapsed .logo span { display: none; }
    .sidebar-collapsed .nav-item span { display: none; }
    .sidebar-collapsed .nav-item { justify-content: center; padding: 0.75rem; }
    .nav { display: flex; flex-direction: column; gap: 0.35rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.9rem; border-radius: 10px; color: #1f2937; text-decoration: none; font-weight: 600; transition: background 0.2s ease, color 0.2s ease; border-left: 3px solid transparent; }
    .nav-item:hover { background: #f3f4f6; color: #b91c1c; }
    .nav-item.active { background: #fef2f2; color: #b91c1c; border-left-color: #b91c1c; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem; }
    .user-avatar { width: 42px; height: 42px; border-radius: 50%; background: #fee2e2; color: #b91c1c; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 0.9rem; font-weight: 600; color: #1f2937; }
    .user-role { font-size: 0.8rem; color: #6b7280; }
    .logout-icon { cursor: pointer; font-size: 1.2rem; color: #6b7280; transition: color 0.2s; }
    .logout-icon:hover { color: #b91c1c; }
    .sidebar-collapsed .sidebar-footer { flex-direction: column; padding: 0.5rem 0; }
    .sidebar-collapsed .user-info { display: none; }
    .sidebar-collapsed .logout-icon { display: none; }
    .main { padding: 1.5rem 2rem; }
    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; flex-direction: row; flex-wrap: wrap; gap: 0.6rem; } .main { padding: 1rem; } }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 0; }
    .header { background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(185, 28, 28, 0.2); }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 2rem; margin: 0; }
    .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .header-actions { display: flex; gap: 0.75rem; align-items: center; }
    .api-toggle { background: rgba(255,255,255,0.2); }
    .logout-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #b91c1c; transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .stat-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
    .stat-label { color: #6b7280; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-icon { font-size: 2rem; }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: #b91c1c; margin-bottom: 0.3rem; }
    .stat-description { color: #6b7280; font-size: 0.85rem; }
    
    .section-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: #111827; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f3f4f6; }
    
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .action-btn { background: white; border: 2px solid #e5e7eb; padding: 1.5rem; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; text-decoration: none; display: block; }
    .action-btn:hover { border-color: #b91c1c; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(185, 28, 28, 0.15); }
    .action-btn .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .action-btn .label { font-weight: 600; color: #111827; }
    
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; }
    .blood-card { background: white; padding: 1.2rem; border-radius: 10px; text-align: center; border: 2px solid #e5e7eb; transition: all 0.2s; }
    .blood-card:hover { border-color: #b91c1c; transform: translateY(-2px); }
    .blood-type { font-size: 1.8rem; font-weight: 700; color: #b91c1c; margin-bottom: 0.5rem; }
    .units { font-size: 1.5rem; font-weight: 700; color: #111827; }
    .level { color: #6b7280; font-size: 0.85rem; margin-top: 0.3rem; }
    
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .spinner { border: 3px solid #e5e7eb; border-top: 3px solid #b91c1c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .requests-table { width: 100%; border-collapse: collapse; }
    .requests-table th { background: #f9fafb; padding: 0.75rem; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
    .requests-table td { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; }
    .requests-table tr:hover { background: #f9fafb; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-fulfilled { background: #d1fae5; color: #065f46; }
    .status-fulfilled { background: #dbeafe; color: #1e40af; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    
    .distribution-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-top: 1rem; }
    .distribution-card { background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); border: 2px solid #e5e7eb; padding: 1.5rem; border-radius: 12px; text-align: center; transition: all 0.2s; }
    .distribution-card:hover { border-color: #b91c1c; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(185, 28, 28, 0.1); }
    .distribution-type { font-size: 2rem; font-weight: 700; color: #b91c1c; margin-bottom: 0.5rem; }
    .distribution-count { font-size: 1.8rem; font-weight: 700; color: #111827; margin-bottom: 0.25rem; }
    .distribution-label { color: #6b7280; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
  </style>
</head>
<body>
  <div class="layout" id="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo"><span>ü©∏</span> <span>Life Link</span></div>
        <button class="toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar">‚ò∞</button>
      </div>
      <nav class="nav">
        <a class="nav-item active" href="./staff-dashboard.html"><span>üè†</span> <span>Dashboard</span></a>
        <a class="nav-item" href="../staff/staff-donor-management.html"><span>üë•</span> <span>Donor Management</span></a>
        <a class="nav-item" href="../shared-pages/donation-recording.html"><span>ü©∏</span> <span>Record Donation</span></a>
        <a class="nav-item" href="../shared-pages/inventory-management.html"><span>üì¶</span> <span>Blood Inventory</span></a>
        <a class="nav-item" href="../shared-pages/request-management.html"><span>üè•</span> <span>Hospital Requests</span></a>
        <a class="nav-item" href="../shared-pages/event-management.html"><span>üìÖ</span> <span>Events</span></a>
        <a class="nav-item" href="../shared-pages/emergency-requests.html"><span>üö®</span> <span>Emergency</span></a>
        <a class="nav-item" href="../shared-pages/reports.html"><span>üìä</span> <span>Reports</span></a>
        <a class="nav-item" href="../shared-pages/audit-logs.html"><span>üìã</span> <span>Audit Logs</span></a>
        <a class="nav-item" href="../staff/pages/staff-profile.html"><span>üë§</span> <span>Profile</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-avatar" id="userInitial">S</div>
        <div class="user-info">
          <div class="user-name" id="userName">Staff</div>
          <div class="user-role">Staff Account</div>
        </div>
        <div class="logout-icon" onclick="logout()" title="Logout">‚á¶</div>
      </div>
    </aside>

    <main class="main">
      <div class="container">
        <div class="header">
          <div class="header-content">
            <div>
              <h1>Staff Dashboard</h1>
              <p style="margin-top: 0.5rem; opacity: 0.9;">Manage donors, inventory, and operations</p>
            </div>
            <div class="header-actions">
              <button class="logout-btn api-toggle" id="apiToggle" onclick="toggleApiBase()">API: Local</button>
              <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Total Donors</div>
              </div>
              <div class="stat-icon">üë•</div>
            </div>
            <div class="stat-value" id="totalDonors">0</div>
            <div class="stat-description">Registered donors</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">This Month</div>
              </div>
              <div class="stat-icon">üìÖ</div>
            </div>
            <div class="stat-value" id="monthlyDonations">0</div>
            <div class="stat-description">Donations this month</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Total Units</div>
              </div>
              <div class="stat-icon">ü©∏</div>
            </div>
            <div class="stat-value" id="totalUnits">0</div>
            <div class="stat-description">Units in inventory</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Events</div>
              </div>
              <div class="stat-icon">üìå</div>
            </div>
            <div class="stat-value" id="upcomingEvents">0</div>
            <div class="stat-description">Upcoming events</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Blood Requests</div>
              </div>
              <div class="stat-icon">ü©∏</div>
            </div>
            <div class="stat-value" id="totalRequests">0</div>
            <div class="stat-description">All hospital requests</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Pending Requests</div>
              </div>
              <div class="stat-icon">‚è≥</div>
            </div>
            <div class="stat-value" id="pendingRequests">0</div>
            <div class="stat-description">Awaiting approval</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div>
                <div class="stat-label">Critical Level</div>
              </div>
              <div class="stat-icon">‚ö†Ô∏è</div>
            </div>
            <div class="stat-value" id="criticalInventory">0</div>
            <div class="stat-description">Blood types below 10 units</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="section-card">
          <h2 class="section-title">‚ö° Quick Actions</h2>
          <div class="quick-actions">
            <a href="../staff/staff-donor-management.html" class="action-btn">
              <div class="icon">‚ûï</div>
              <div class="label">Add Donor</div>
            </a>
            <a href="../shared-pages/inventory-management.html" class="action-btn">
              <div class="icon">üì¶</div>
              <div class="label">Manage Inventory</div>
            </a>
            <a href="../shared-pages/event-management.html" class="action-btn">
              <div class="icon">üìÖ</div>
              <div class="label">Create Event</div>
            </a>
            <a href="../shared-pages/reports.html" class="action-btn">
              <div class="icon">üìä</div>
              <div class="label">View Reports</div>
            </a>
          </div>
        </div>

        <!-- Blood Inventory -->
        <div class="section-card">
          <h2 class="section-title">ü©∏ Blood Inventory Status</h2>
          <div id="bloodInventory">
            <div class="loading">
              <div class="spinner"></div>
              Loading inventory...
            </div>
          </div>
        </div>

        <!-- Recent Requests -->
        <div class="section-card">
          <h2 class="section-title">üìã Recent Blood Requests</h2>
          <div id="recentRequests">
            <div class="loading">
              <div class="spinner"></div>
              Loading requests...
            </div>
          </div>
        </div>

        <!-- Blood Type Distribution -->
        <div class="section-card">
          <h2 class="section-title">üìä Donor Blood Type Distribution</h2>
          <div id="bloodTypeDistribution">
            <div class="loading">
              <div class="spinner"></div>
              Loading distribution data...
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../shared-pages/api-base.js"></script>
  <script>
    // Sidebar toggle functionality
    function toggleSidebar() {
      const layout = document.getElementById('layout');
      layout.classList.toggle('sidebar-collapsed');
      localStorage.setItem('sidebarCollapsed', layout.classList.contains('sidebar-collapsed'));
    }

    // Restore sidebar state
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
      document.getElementById('layout').classList.add('sidebar-collapsed');
    }

    const REQUEST_TIMEOUT_MS = 15000;

    async function fetchWithTimeout(url, options = {}, retries = 1) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
      try {
        return await fetch(url, { ...options, signal: controller.signal });
      } catch (error) {
        if (retries > 0 && error.name === 'AbortError') {
          return fetchWithTimeout(url, options, retries - 1);
        }
        throw error;
      } finally {
        clearTimeout(timeoutId);
      }
    }

const API_BASE = window.LIFELINK_API_BASE || 'http://localhost:3000';

    function updateApiToggleLabel() {
      const btn = document.getElementById('apiToggle');
      if (!btn) return;
      btn.textContent = API_BASE.includes('localhost') ? 'API: Local' : 'API: Render';
    }

    function toggleApiBase() {
        if (window.LifeLinkApi?.toggle) {
          window.LifeLinkApi.toggle();
      }
    }

    updateApiToggleLabel();

    // Check authentication
    const userType = localStorage.getItem('userType');
    const token = localStorage.getItem('token');
    const staffId = localStorage.getItem('staffId') || localStorage.getItem('userId');
    if (!token || userType !== 'staff' || !staffId) {
      window.location.href = '../login-staff.html';
    }

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('userType');
      localStorage.removeItem('staffId');
      localStorage.removeItem('userId');
      window.location.href = '../login-staff.html';
    }

    // Fetch dashboard statistics
    async function fetchStats() {
      try {
        console.log('[fetchStats] Starting to fetch stats with API_BASE:', API_BASE);
        
        // Fetch total donors
        const donorsResponse = await fetchWithTimeout(`${API_BASE}/api/donors`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchStats] Donors response status:', donorsResponse.status);
        
        if (donorsResponse.ok) {
          const result = await donorsResponse.json();
          console.log('[fetchStats] Donors result:', result);
          const donors = result.data || result;  // Handle both formats
          document.getElementById('totalDonors').textContent = Array.isArray(donors) ? donors.length : 0;
        } else {
          console.error('[fetchStats] Donors fetch failed:', donorsResponse.status);
          document.getElementById('totalDonors').textContent = 0;
        }

        // Fetch monthly donations
        const donationsResponse = await fetchWithTimeout(`${API_BASE}/api/donations`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchStats] Donations response status:', donationsResponse.status);
        
        if (donationsResponse.ok) {
          const donations = await donationsResponse.json();
          console.log('[fetchStats] Donations result:', donations);
          const donationsArray = Array.isArray(donations) ? donations : (donations.data || []);
          const thisMonth = new Date().getMonth();
          const thisYear = new Date().getFullYear();
          const monthlyDonations = donationsArray.filter(d => {
            const donationDate = new Date(d.donation_date || d.date);
            return donationDate.getMonth() === thisMonth && donationDate.getFullYear() === thisYear;
          });
          document.getElementById('monthlyDonations').textContent = monthlyDonations.length;
        } else {
          console.error('[fetchStats] Donations fetch failed:', donationsResponse.status);
          document.getElementById('monthlyDonations').textContent = 0;
        }

        // Fetch inventory
        const inventoryResponse = await fetchWithTimeout(`${API_BASE}/api/staff/inventory`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchStats] Inventory response status:', inventoryResponse.status);
        
        if (inventoryResponse.ok) {
          const inventoryResult = await inventoryResponse.json();
          console.log('[fetchStats] Inventory result:', inventoryResult);
          const inventoryData = Array.isArray(inventoryResult) ? inventoryResult : (inventoryResult.data || []);
          
          // Count total units (each row in blood_inventory is 1 unit)
          const totalUnits = inventoryData.filter(item => item.status === 'available').length;
          document.getElementById('totalUnits').textContent = totalUnits;

          // Group by blood type to check critical levels
          const byType = {};
          inventoryData.forEach(item => {
            if (item.status === 'available') {
              const type = item.blood_type || item.type;
              byType[type] = (byType[type] || 0) + 1;
            }
          });

          const criticalCount = Object.values(byType).filter(count => count < 10).length;
          document.getElementById('criticalInventory').textContent = criticalCount;
        } else {
          console.error('[fetchStats] Inventory fetch failed:', inventoryResponse.status);
          document.getElementById('totalUnits').textContent = 0;
          document.getElementById('criticalInventory').textContent = 0;
        }

        // Fetch events
        const eventsResponse = await fetchWithTimeout(`${API_BASE}/api/events`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchStats] Events response status:', eventsResponse.status);
        
        if (eventsResponse.ok) {
          const eventsResult = await eventsResponse.json();
          console.log('[fetchStats] Events result:', eventsResult);
          const events = Array.isArray(eventsResult) ? eventsResult : (eventsResult.data || []);
          // Filter upcoming events
          const now = new Date();
          const upcomingEvents = events.filter(e => new Date(e.date) >= now);
          document.getElementById('upcomingEvents').textContent = upcomingEvents.length;
        } else {
          console.error('[fetchStats] Events fetch failed:', eventsResponse.status);
          document.getElementById('upcomingEvents').textContent = 0;
        }

        // Fetch blood requests
        const requestsResponse = await fetchWithTimeout(`${API_BASE}/api/staff/requests`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchStats] Requests response status:', requestsResponse.status);
        
        if (requestsResponse.ok) {
          const requestsResult = await requestsResponse.json();
          console.log('[fetchStats] Requests result:', requestsResult);
          const requests = Array.isArray(requestsResult) ? requestsResult : (requestsResult.data || []);
          document.getElementById('totalRequests').textContent = requests.length;
          
          const pendingCount = requests.filter(r => r.status === 'pending').length;
          document.getElementById('pendingRequests').textContent = pendingCount;
        } else {
          console.error('[fetchStats] Requests fetch failed:', requestsResponse.status);
          document.getElementById('totalRequests').textContent = 0;
          document.getElementById('pendingRequests').textContent = 0;
        }
        
        console.log('[fetchStats] All stats fetched successfully');
      } catch (error) {
        console.error('[fetchStats] Error fetching stats:', error);
        // Set default values on error
        document.getElementById('totalDonors').textContent = 0;
        document.getElementById('monthlyDonations').textContent = 0;
        document.getElementById('totalUnits').textContent = 0;
        document.getElementById('upcomingEvents').textContent = 0;
        document.getElementById('totalRequests').textContent = 0;
        document.getElementById('pendingRequests').textContent = 0;
        document.getElementById('criticalInventory').textContent = 0;
      }
    }

    // Fetch blood inventory
    async function fetchBloodInventory() {
      try {
        console.log('[fetchBloodInventory] Fetching inventory from:', `${API_BASE}/api/inventory`);
        const response = await fetchWithTimeout(`${API_BASE}/api/inventory`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('[fetchBloodInventory] Response status:', response.status);

        let inventory = [];

        if (response.ok) {
          const inventoryResult = await response.json();
          console.log('[fetchBloodInventory] Inventory result:', inventoryResult);
          inventory = Array.isArray(inventoryResult) ? inventoryResult : (inventoryResult.data || []);
        }
        
        const inventoryDiv = document.getElementById('bloodInventory');

        if (inventory.length === 0) {
          inventoryDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No inventory data available.</p>';
          return;
        }

        const bloodTypes = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
        const totals = inventory.reduce((acc, item) => {
          if (item.status === 'available') {
            const type = item.blood_type || item.type;
            acc[type] = (acc[type] || 0) + 1; // Each row is 1 unit
          }
          return acc;
        }, {});
        
        console.log('[fetchBloodInventory] Blood type totals:', totals);

        inventoryDiv.innerHTML = '<div class="inventory-grid">' + bloodTypes.map(type => {
          const units = totals[type] || 0;
          let level = 'Low';
          if (units >= 50) level = 'Good';
          else if (units >= 20) level = 'Medium';

          return `
            <div class="blood-card">
              <div class="blood-type">${type}</div>
              <div class="units">${units}</div>
              <div class="level">${level}</div>
            </div>
          `;
        }).join('') + '</div>';
      } catch (error) {
        console.error('[fetchBloodInventory] Error fetching inventory:', error);
        document.getElementById('bloodInventory').innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Error loading inventory data.</p>';
      }
    }

    // Fetch recent requests
    async function fetchRecentRequests() {
      try {
        const response = await fetchWithTimeout(`${API_BASE}/api/staff/requests`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        let requests = [];

        if (response.ok) {
          const result = await response.json();
          requests = result.data || result;  // Handle both formats
        }
        
        const requestsDiv = document.getElementById('recentRequests');

        if (!requests || requests.length === 0) {
          requestsDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No requests found.</p>';
          return;
        }

        // Show most recent 10 requests
        const recentRequests = requests.slice(0, 10);
        
        requestsDiv.innerHTML = `
          <table class="requests-table">
            <thead>
              <tr>
                <th>Hospital</th>
                <th>Blood Type</th>
                <th>Units</th>
                <th>Urgency</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              ${recentRequests.map(request => `
                <tr>
                  <td><strong>${request.hospital_name || 'Unknown Hospital'}</strong></td>
                  <td><span style="color: #b91c1c; font-weight: 600;">${request.blood_type}</span></td>
                  <td>${request.quantity_required} ml</td>
                  <td><span style="color: ${request.urgency === 'emergency' ? '#dc2626' : request.urgency === 'urgent' ? '#f59e0b' : '#10b981'}; font-weight: 600;">${request.urgency}</span></td>
                  <td><span class="status-badge status-${request.status}">${request.status}</span></td>
                  <td>${new Date(request.request_date).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Error fetching requests:', error);
        // Display sample data on error
        const sampleRequests = [
          { hospital_name: 'City General Hospital', blood_type: 'O-', quantity_required: 2000, urgency: 'emergency', status: 'pending', request_date: new Date(Date.now() - 1*60*60*1000).toISOString() },
          { hospital_name: 'St. Mary Medical Center', blood_type: 'A+', quantity_required: 1500, urgency: 'urgent', status: 'pending', request_date: new Date(Date.now() - 3*60*60*1000).toISOString() },
          { hospital_name: 'Memorial Hospital', blood_type: 'B+', quantity_required: 1000, urgency: 'routine', status: 'fulfilled', request_date: new Date(Date.now() - 6*60*60*1000).toISOString() }
        ];
        document.getElementById('recentRequests').innerHTML = `
          <table class="requests-table">
            <thead>
              <tr>
                <th>Hospital</th>
                <th>Blood Type</th>
                <th>Units</th>
                <th>Urgency</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              ${sampleRequests.map(request => `
                <tr>
                  <td><strong>${request.hospital_name}</strong></td>
                  <td><span style="color: #b91c1c; font-weight: 600;">${request.blood_type}</span></td>
                  <td>${request.quantity_required} ml</td>
                  <td><span style="color: ${request.urgency === 'emergency' ? '#dc2626' : request.urgency === 'urgent' ? '#f59e0b' : '#10b981'}; font-weight: 600;">${request.urgency}</span></td>
                  <td><span class="status-badge status-${request.status}">${request.status}</span></td>
                  <td>${new Date(request.request_date).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
    }

    // Fetch blood type distribution
    async function fetchBloodTypeDistribution() {
      try {
        const response = await fetchWithTimeout(`${API_BASE}/api/donors`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch donors');

        const result = await response.json();
        const donors = result.data || result;  // Handle both {success, data} and array formats
        const distributionDiv = document.getElementById('bloodTypeDistribution');

        if (!donors || donors.length === 0) {
          distributionDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No donor data available.</p>';
          return;
        }

        // Count donors by blood type
        const bloodTypes = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
        const distribution = {};
        bloodTypes.forEach(type => {
          distribution[type] = donors.filter(d => d.blood_type === type).length;
        });

        distributionDiv.innerHTML = `
          <div class="distribution-grid">
            ${bloodTypes.map(type => `
              <div class="distribution-card">
                <div class="distribution-type">${type}</div>
                <div class="distribution-count">${distribution[type]}</div>
                <div class="distribution-label">Donors</div>
              </div>
            `).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Error fetching blood type distribution:', error);
        document.getElementById('bloodTypeDistribution').innerHTML = '<div class="alert alert-info">Failed to load distribution data.</div>';
      }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      fetchStats();
      fetchBloodInventory();
      fetchRecentRequests();
      fetchBloodTypeDistribution();
    });
  </script>
</body>
</html>
