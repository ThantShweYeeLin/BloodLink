<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Donor Profile ‚Äî Life Link</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #111827; }
    .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    .sidebar { background: #ffffff; border-right: 1px solid #e5e7eb; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.4rem; position: sticky; top: 0; height: 100vh; }
    .logo { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; color: #b91c1c; margin-bottom: 0.75rem; }
    .nav { display: flex; flex-direction: column; gap: 0.35rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.9rem; border-radius: 10px; color: #1f2937; text-decoration: none; font-weight: 600; transition: background 0.2s ease, color 0.2s ease; border-left: 3px solid transparent; }
    .nav-item:hover { background: #f3f4f6; color: #b91c1c; }
    .nav-item.active { background: #fef2f2; color: #b91c1c; border-left-color: #b91c1c; }
    .main { padding: 1.5rem 2rem; }
    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr; } .sidebar { position: relative; height: auto; flex-direction: row; flex-wrap: wrap; gap: 0.6rem; } .main { padding: 1rem; } }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 0; }
    .header { background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(185, 28, 28, 0.2); }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 2rem; margin: 0; }
    .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
    
    .profile-card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .profile-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #f3f4f6; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: 700; box-shadow: 0 4px 12px rgba(185, 28, 28, 0.3); }
    .profile-info { flex: 1; }
    .profile-info h2 { margin: 0 0 0.5rem; font-size: 1.8rem; color: #111827; }
    .profile-info p { color: #6b7280; margin: 0.3rem 0; font-size: 0.95rem; }
    .blood-type-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: #fee2e2; color: #b91c1c; padding: 0.5rem 1.2rem; border-radius: 20px; font-size: 1.2rem; font-weight: 700; margin-top: 0.5rem; border: 2px solid #fecaca; }
    .profile-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1.5rem; }
    .stat-box { background: #f9fafb; padding: 1.2rem; border-radius: 10px; text-align: center; border-left: 3px solid #b91c1c; transition: all 0.2s; }
    .stat-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .stat-box .number { font-size: 2rem; font-weight: 700; color: #b91c1c; }
    .stat-box .label { font-size: 0.85rem; color: #6b7280; margin-top: 0.3rem; }
    
    .section { margin-bottom: 2rem; }
    .section-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: #111827; display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f3f4f6; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
    .info-item { background: #f9fafb; padding: 1.2rem; border-radius: 8px; border-left: 3px solid #e5e7eb; transition: all 0.2s; }
    .info-item:hover { border-left-color: #b91c1c; transform: translateX(2px); }
    .info-label { color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value { font-weight: 600; font-size: 1.05rem; color: #111827; }
    
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
    input, select { width: 100%; padding: 0.85rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.95rem; }
    input:focus, select:focus { outline: none; border-color: #b91c1c; box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.1); background: #fff; }
    
    .btn { background: #b91c1c; color: white; border: none; padding: 0.85rem 1.8rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 0.5rem; transition: all 0.2s; font-size: 0.95rem; }
    .btn:hover { background: #a01818; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(185, 28, 28, 0.3); }
    .btn-secondary { background: #6b7280; }
    .btn-secondary:hover { background: #4b5563; transform: translateY(-1px); }
    .button-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    
    .table-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f9fafb; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; color: #374151; }
    td { padding: 1rem; border-bottom: 1px solid #e5e7eb; }
    tr:hover { background: #f9fafb; }
    .badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 999px; font-size: 0.8rem; font-weight: 600; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    
    .alert { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #86efac; }
    .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .spinner { border: 3px solid #e5e7eb; border-top: 3px solid #b91c1c; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .eligibility-banner { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; }
    .eligibility-banner.ineligible { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .eligibility-banner .icon { font-size: 2rem; }
    .eligibility-banner .text { flex: 1; }
    .eligibility-banner .text h3 { margin: 0 0 0.3rem; font-size: 1.1rem; }
    .eligibility-banner .text p { margin: 0; opacity: 0.9; font-size: 0.9rem; }
    
    @media (max-width: 768px) {
      .profile-stats { grid-template-columns: repeat(2, 1fr); }
      .profile-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">ü©∏ Life Link Donor</div>
      <nav class="nav">
        <a class="nav-item" href="../dashboards/donor-dashboard.html">üè† Dashboard</a>
        <a class="nav-item active" href="./donor-profile.html">üë§ Profile</a>
        <a class="nav-item" href="./donor-donation-history.html">üßæ Donation History</a>
        <a class="nav-item" href="./donor-eligibility.html">‚úÖ Eligibility</a>
        <a class="nav-item" href="./donor-events.html">üìÖ Events</a>
        <a class="nav-item" href="./donor-appointments.html">‚è∞ Appointments</a>
        <a class="nav-item" href="./donor-notifications.html">üîî Notifications</a>
        <a class="nav-item" href="./donor-rewards.html">üéñÔ∏è Rewards</a>
        <a class="nav-item" href="./donor-faq.html">‚ùì FAQ</a>
      </nav>
    </aside>
    <main class="main">
      <div class="container">
        <div class="header">
          <div class="header-content">
            <h1>ü©∏ Donor Profile</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
          </div>
        </div>

        <div id="alertContainer"></div>

        <div id="eligibilityBanner"></div>

        <div class="profile-card">
          <div class="profile-header">
            <div class="profile-avatar" id="avatar">ü©∏</div>
            <div class="profile-info">
              <h2 id="donorName">Loading...</h2>
              <p>üìß <span id="donorEmail">-</span></p>
              <p>üì± <span id="donorPhone">-</span></p>
              <div class="blood-type-badge" id="bloodTypeBadge">
                ü©∏ <span id="bloodType">-</span>
              </div>
              <div class="profile-stats">
                <div class="stat-box">
                  <div class="number" id="totalDonations">0</div>
                  <div class="label">Total Donations</div>
                </div>
                <div class="stat-box">
                  <div class="number" id="totalVolume">0</div>
                  <div class="label">Total mL Donated</div>
                </div>
                <div class="stat-box">
                  <div class="number" id="livesImpacted">0</div>
                  <div class="label">Lives Impacted</div>
                </div>
                <div class="stat-box">
                  <div class="number" id="memberYears">0</div>
                  <div class="label">Years as Donor</div>
                </div>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="section-title">üìã Personal Information</div>
            <div class="info-grid" id="personalInfo">
              <div class="loading"><div class="spinner"></div>Loading profile...</div>
            </div>
          </div>
        </div>

        <div class="profile-card">
          <div class="section">
            <div class="section-title">‚úèÔ∏è Edit Profile</div>
            <form id="editForm" onsubmit="saveProfile(event)">
              <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="fullName" required>
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" required>
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="phone">
              </div>
              <div class="form-group">
                <label>Address</label>
                <input type="text" id="address">
              </div>
              <div class="button-group">
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">Discard</button>
              </div>
            </form>
          </div>
        </div>

        <div class="profile-card">
          <div class="section">
            <div class="section-title">üîí Change Password</div>
            <form id="passwordForm" onsubmit="changePassword(event)">
              <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" required>
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" required minlength="8">
              </div>
              <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" required minlength="8">
              </div>
              <div class="button-group">
                <button type="submit" class="btn">Update Password</button>
                <button type="button" class="btn btn-secondary" onclick="resetPasswordForm()">Clear</button>
              </div>
            </form>
          </div>
        </div>

        <div class="profile-card">
          <div class="section">
            <div class="section-title">ü©∏ Donation History</div>
            <div class="table-card">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Blood Type</th>
                    <th>Quantity</th>
                    <th>Location</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="donationsTable">
                  <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading donations...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = window.LIFELINK_API_BASE || 'http://localhost:3000';
    const API_URL = API_BASE.endsWith('/api') ? API_BASE : `${API_BASE}/api`;
    let currentDonorData = null;

    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '../login-donor.html';
        return false;
      }
      return true;
    }

    function getAuthHeader() {
      return {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      };
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
      try {
        const options = { method, headers: getAuthHeader() };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const data = await response.json();
        if (!response.ok && response.status === 401) {
          localStorage.clear();
          window.location.href = '../login-donor.html';
        }
        return data;
      } catch (error) {
        console.error('API Error:', error);
        return { success: false, message: 'Network error' };
      }
    }

    async function loadProfile() {
      const donorId = localStorage.getItem('donorId');
      const data = await apiCall(`/donor/profile/${donorId}`);

      if (!data.success) return showAlert('Failed to load profile', 'error');

      const donationsResponse = await apiCall(`/donations/donor/${donorId}`);
      const donations = Array.isArray(donationsResponse) ? donationsResponse : (donationsResponse.data || donationsResponse || []);

      currentDonorData = { ...data.data, donations };

      // Update header
      const initial = data.data.full_name.charAt(0).toUpperCase();
      document.getElementById('avatar').textContent = initial;
      document.getElementById('donorName').textContent = data.data.full_name;
      document.getElementById('donorEmail').textContent = data.data.email;
      document.getElementById('donorPhone').textContent = data.data.phone || 'Not provided';
      document.getElementById('bloodType').textContent = data.data.blood_type;

      // Calculate stats
      const totalDonations = donations.length;
      const totalVolume = donations.reduce((sum, d) => sum + (d.quantity_ml || 0), 0);
      const livesImpacted = Math.floor(totalVolume / 450); // ~450ml can save a life
      const joinDate = new Date(data.data.registration_date || data.data.created_at || Date.now());
      const years = ((new Date() - joinDate) / (1000 * 60 * 60 * 24 * 365)).toFixed(1);

      document.getElementById('totalDonations').textContent = totalDonations;
      document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();
      document.getElementById('livesImpacted').textContent = livesImpacted;
      document.getElementById('memberYears').textContent = years;

      // Check eligibility
      checkEligibility(donations);

      // Update form
      document.getElementById('fullName').value = data.data.full_name;
      document.getElementById('email').value = data.data.email;
      document.getElementById('phone').value = data.data.phone || '';
      document.getElementById('address').value = data.data.address || '';

      // Display personal info
      const infoHtml = `
        <div class="info-item">
          <div class="info-label">Donor ID</div>
          <div class="info-value">#${String(data.data.id).padStart(4, '0')}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Blood Type</div>
          <div class="info-value">${data.data.blood_type}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Date of Birth</div>
          <div class="info-value">${data.data.date_of_birth ? new Date(data.data.date_of_birth).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not provided'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Gender</div>
          <div class="info-value">${data.data.gender || 'Not specified'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Address</div>
          <div class="info-value">${data.data.address || 'Not provided'}</div>
        </div>
        <div class="info-item">
          <div class="info-label">Member Since</div>
          <div class="info-value">${new Date(data.data.registration_date || data.data.created_at || Date.now()).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
        </div>
      `;
      document.getElementById('personalInfo').innerHTML = infoHtml;

      // Load donation history
      loadDonationHistory(donations);
    }

    function checkEligibility(donations) {
      // Ensure donations is an array
      const donationsList = Array.isArray(donations) ? donations : [];
      const lastDonation = donationsList.length > 0 ? donationsList[donationsList.length - 1] : null;
      
      let eligible = true;
      let message = '';
      
      if (lastDonation && lastDonation.donation_date) {
        // Has previous donations - check if enough time has passed
        const lastDonationDate = new Date(lastDonation.donation_date);
        const today = new Date();
        const daysSinceLastDonation = Math.floor((today - lastDonationDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceLastDonation < 56) { 
          // Not enough time since last donation (need 8 weeks = 56 days)
          eligible = false;
          const daysRemaining = 56 - daysSinceLastDonation;
          message = `You can donate again in ${daysRemaining} days (8 weeks between donations required).`;
        } else {
          // Enough time has passed
          eligible = true;
          message = 'You are eligible to donate! Thank you for continuing to save lives.';
        }
      } else {
        // No previous donations - new donor is eligible
        eligible = true;
        message = 'Welcome! You are eligible to make your first donation.';
      }

      const banner = document.getElementById('eligibilityBanner');
      banner.innerHTML = `
        <div class="eligibility-banner ${!eligible ? 'ineligible' : ''}">
          <div class="icon">${eligible ? '‚úÖ' : '‚è∞'}</div>
          <div class="text">
            <h3>${eligible ? 'Eligible to Donate' : 'Not Eligible Yet'}</h3>
            <p>${message}</p>
          </div>
        </div>
      `;
    }

    function loadDonationHistory(donations) {
      if (!donations || donations.length === 0) {
        document.getElementById('donationsTable').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #9ca3af;">No donation history yet. Schedule your first donation!</td></tr>';
        return;
      }

      const html = donations.map(d => `
        <tr>
          <td>${new Date(d.donation_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
          <td><strong>${d.blood_type}</strong></td>
          <td>${d.quantity_ml} mL</td>
          <td>${d.location || 'Life Link Center'}</td>
          <td><span class="badge badge-success">${d.status || 'Completed'}</span></td>
        </tr>
      `).join('');

      document.getElementById('donationsTable').innerHTML = html;
    }

    async function saveProfile(e) {
      e.preventDefault();

      const donorId = localStorage.getItem('donorId');
      const data = {
        full_name: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address: document.getElementById('address').value
      };

      const result = await apiCall(`/donors/${donorId}`, 'PUT', data);

      if (result.success) {
        showAlert('Profile updated successfully', 'success');
        currentDonorData = { ...currentDonorData, ...data };
        document.getElementById('donorName').textContent = data.full_name;
      } else {
        showAlert(result.message || 'Failed to update profile', 'error');
      }
    }

    function resetForm() {
      document.getElementById('fullName').value = currentDonorData.full_name;
      document.getElementById('email').value = currentDonorData.email;
      document.getElementById('phone').value = currentDonorData.phone || '';
      document.getElementById('address').value = currentDonorData.address || '';
    }

    async function changePassword(e) {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        return showAlert('Passwords do not match', 'error');
      }

      const donorId = localStorage.getItem('donorId');
      const result = await apiCall(`/donors/${donorId}/password`, 'PUT', {
        current_password: document.getElementById('currentPassword').value,
        new_password: newPassword
      });

      if (result.success) {
        showAlert('Password changed successfully', 'success');
        resetPasswordForm();
      } else {
        showAlert(result.message || 'Failed to change password', 'error');
      }
    }

    function resetPasswordForm() {
      document.getElementById('passwordForm').reset();
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
      const icon = type === 'success' ? '‚úì' : '‚úó';
      container.innerHTML = `<div class="alert ${alertClass}">${icon} ${message}</div>`;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../login-donor.html';
    }

    if (checkAuth()) {
      loadProfile();
    }
  </script>
</body>
</html>
