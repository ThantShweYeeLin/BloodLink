<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Dashboard ‚Äî Life Link</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #111827;
      min-height: 100vh;
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
      transition: grid-template-columns 0.25s ease;
    }

    .sidebar {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      transition: width 0.25s ease;
    }

    .sidebar.collapsed { width: 82px; padding: 1.25rem 0.75rem; }
    body.sidebar-collapsed .layout { grid-template-columns: 82px 1fr; }
    .sidebar.collapsed .logo span:not(.badge),
    .sidebar.collapsed .nav-item span:not(.icon),
    .sidebar.collapsed .sidebar-footer div,
    .sidebar.collapsed .badge { display: none; }
    .sidebar.collapsed .logo { justify-content: center; }
    .sidebar.collapsed .nav-item { justify-content: center; }
    .sidebar.collapsed .sidebar-footer { justify-content: center; }

    .logo {
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #b91c1c;
    }

    .badge {
      background: #eef2ff;
      color: #4338ca;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0.9rem;
      border-radius: 10px;
      color: #1f2937;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .nav-item .icon { font-size: 1.1rem; }

    .nav-item.active {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fde8e8;
    }

    .nav-item:hover { background: #f3f4f6; }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: #fee2e2;
      color: #b91c1c;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .main {
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .topbar {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 0.85rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0.75rem;
      z-index: 5;
    }

    .search {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.55rem 0.75rem;
    }

    .search input {
      border: none;
      background: transparent;
      flex: 1;
      font-size: 0.95rem;
      outline: none;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .icon-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #fff;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .pill-btn {
      background: #b91c1c;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 0.8rem 1.2rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(185, 28, 28, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .pill-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(185, 28, 28, 0.3); }

    .page-header h1 { margin: 0; font-size: 1.6rem; }
    .page-subtitle { margin: 0.15rem 0 0; color: #6b7280; font-size: 0.98rem; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .stat-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 1rem 1.2rem;
      display: grid;
      gap: 0.35rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.04);
    }

    .stat-label { color: #6b7280; font-weight: 600; font-size: 0.9rem; }
    .stat-value { font-size: 2rem; font-weight: 800; }
    .stat-meta { color: #22c55e; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.35rem; }
    .stat-icon { color: #b91c1c; font-size: 1.25rem; }

    .section-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 8px 16px rgba(0,0,0,0.04);
    }

    .section-title { margin: 0 0 0.6rem; font-size: 1.05rem; font-weight: 700; }
    .section-sub { margin: 0 0 1rem; color: #6b7280; font-size: 0.95rem; }

    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.9rem;
    }

    .inventory-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      background: #fff;
      display: grid;
      gap: 0.35rem;
      position: relative;
    }

    .blood-type { font-size: 1.4rem; font-weight: 800; color: #b91c1c; }
    .level { font-size: 0.9rem; color: #6b7280; }
    .units { font-size: 1.4rem; font-weight: 800; }
    .units span { font-size: 0.9rem; font-weight: 600; color: #6b7280; }

    .progress {
      height: 6px;
      border-radius: 999px;
      background: #f3f4f6;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      width: 0%;
      transition: width 0.3s ease;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.2rem 0.55rem;
      background: #fef2f2;
      color: #b91c1c;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .page {
      display: none;
      flex-direction: column;
      gap: 1rem;
    }

    .page.active { display: flex; }

    .placeholder {
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      border-radius: 12px;
      padding: 1.4rem;
      color: #6b7280;
      text-align: center;
    }

    @media (max-width: 1024px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: relative; height: auto; flex-direction: row; flex-wrap: wrap; gap: 0.6rem; }
      .sidebar-footer { width: 100%; }
    }

    @media (max-width: 768px) {
      .topbar { flex-direction: column; align-items: stretch; }
      .top-actions { width: 100%; justify-content: space-between; }
      .search { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">
        ü©∏ Life Link <span class="badge">Hospital</span>
      </div>
      <nav class="nav">
        <a class="nav-item active" data-page="dashboard"><span class="icon">üè†</span> Dashboard</a>
        <a class="nav-item" href="../pages/hospital-submit-request.html"><span class="icon">üìù</span> Submit Request</a>
        <a class="nav-item" href="../pages/hospital-request-status.html"><span class="icon">üìä</span> Request Status</a>
        <a class="nav-item" href="../pages/hospital-emergency-request.html"><span class="icon">üö®</span> Emergency</a>
        <a class="nav-item" href="../pages/hospital-request-history.html"><span class="icon">üïë</span> History & Reports</a>
        <a class="nav-item" href="../pages/hospital-notifications.html"><span class="icon">üîî</span> Notifications</a>
        <a class="nav-item" href="../pages/hospital-profile.html"><span class="icon">üë§</span> Profile</a>
        <a class="nav-item" href="../pages/hospital-analytics.html"><span class="icon">üìà</span> Analytics</a>
      </nav>
      <div class="sidebar-footer">
        <div class="avatar" id="userInitial">H</div>
        <div>
          <div id="userName">Hospital</div>
          <small style="color:#6b7280;">Hospital Account</small>
        </div>
        <button class="icon-btn" onclick="logout()" title="Logout">‚á¶</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <span>üîç</span>
          <input type="text" placeholder="Search donors, hospitals, requests..." aria-label="Search" />
        </div>
        <div class="top-actions">
          <button class="icon-btn" id="sidebarToggle" title="Toggle sidebar">‚ò∞</button>
          <button class="icon-btn" title="Notifications">üîî</button>
          <button class="icon-btn" title="Toggle theme">üåô</button>
          <button class="pill-btn" onclick="createRequest()">Create Request</button>
        </div>
      </div>

      <section id="dashboardPage" class="page active">
        <div class="page-header">
          <h1>Hospital Dashboard</h1>
          <p class="page-subtitle">Manage blood requests and view available inventory.</p>
        </div>

        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-label">TOTAL REQUESTS</div>
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-meta"><span class="stat-icon">üóìÔ∏è</span><span id="stat-total-meta">This month</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">FULFILLED</div>
            <div class="stat-value" id="stat-fulfilled">0</div>
            <div class="stat-meta" id="stat-success">‚Üë 0% success rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">PENDING</div>
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-meta" style="color:#f97316"><span class="stat-icon">‚è≥</span>Awaiting fulfillment</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">CANCELLED</div>
            <div class="stat-value" id="stat-cancelled">0</div>
            <div class="stat-meta" style="color:#ef4444"><span class="stat-icon">‚úñÔ∏è</span>Closed requests</div>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title">Available Blood Inventory</div>
          <p class="section-sub">Live view of current stock by blood type</p>
          <div class="inventory-grid" id="inventoryGrid"></div>
        </div>
      </section>

      <section id="historyPage" class="page">
        <div class="page-header">
          <h1>Request History</h1>
          <p class="page-subtitle">Track past and current blood requests.</p>
        </div>
        <div class="placeholder">Request history coming soon.</div>
      </section>

      <section id="inventoryPage" class="page">
        <div class="page-header">
          <h1>Available Inventory</h1>
          <p class="page-subtitle">Detailed inventory management (coming soon).</p>
        </div>
        <div class="placeholder">Inventory management coming soon.</div>
      </section>

      <section id="donorsPage" class="page">
        <div class="page-header">
          <h1>Donors</h1>
          <p class="page-subtitle">Find and contact donors by blood type.</p>
        </div>
        <div class="placeholder">Donor directory coming soon.</div>
      </section>
    </main>
  </div>

  <script>
    function getAuth() {
      const token = localStorage.getItem('token');
      const hospitalId = localStorage.getItem('hospitalId');
      if (!token || !hospitalId) {
        window.location.href = '../login-hospital.html';
        return null;
      }
      return { token, hospitalId };
    }

    function setUserProfile(profile) {
      const name = profile?.hospital_name || localStorage.getItem('userName') || 'Hospital';
      document.getElementById('userName').textContent = name;
      document.getElementById('userInitial').textContent = name.charAt(0).toUpperCase();
    }

    function renderStats(stats) {
      const total = stats.totalRequests || 0;
      const fulfilled = stats.fulfilledRequests || 0;
      const pending = stats.pendingRequests || 0;
      const cancelled = stats.cancelledRequests || 0;
      const success = stats.successRate || 0;

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-fulfilled').textContent = fulfilled;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-cancelled').textContent = cancelled;
      document.getElementById('stat-success').textContent = `‚Üë ${success}% success rate`;
    }

    function classifyLevel(amount) {
      if (amount >= 160) return { label: 'Full', tone: '#16a34a' };
      if (amount >= 110) return { label: 'Medium', tone: '#f59e0b' };
      if (amount >= 60) return { label: 'Low', tone: '#f97316' };
      return { label: 'Critical', tone: '#ef4444' };
    }

    function renderInventory(inventoryByType = {}) {
      const order = ['A+','A-','B+','B-','AB+','AB-','O+','O-'];
      const container = document.getElementById('inventoryGrid');
      const capacity = 200;

      const cards = order.map(type => {
        const data = inventoryByType[type] || { total: 0, expiring: 0 };
        const pct = Math.min(100, Math.round((data.total / capacity) * 100));
        const level = classifyLevel(data.total);
        const expiringBadge = data.expiring > 0 ? `<span class="pill">‚è∞ ${data.expiring} expiring</span>` : '';
        return `
          <div class="inventory-card">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <div>
                <div class="blood-type">${type}</div>
                <div class="level" style="color:${level.tone};">${level.label}</div>
              </div>
              ${expiringBadge}
            </div>
            <div class="units">${data.total}<span> units</span></div>
            <div class="progress"><div class="progress-bar" style="width:${pct}%;"></div></div>
            <div class="level" style="margin-top:0.2rem;">${pct}% of capacity</div>
          </div>`;
      }).join('');

      container.innerHTML = cards;
    }

    async function loadDashboard() {
      const auth = getAuth();
      if (!auth) return;

      try {
        const [profileRes, statsRes] = await Promise.all([
          fetch(`/api/hospital/profile/${auth.hospitalId}`, { headers: { 'Authorization': `Bearer ${auth.token}` } }),
          fetch(`/api/dashboard/stats/hospital/${auth.hospitalId}`, { headers: { 'Authorization': `Bearer ${auth.token}` } })
        ]);

        if (profileRes.ok) {
          const profile = await profileRes.json();
          setUserProfile(profile.data);
        }

        if (statsRes.ok) {
          const stats = await statsRes.json();
          renderStats(stats.data || {});
          renderInventory(stats.data?.inventoryByType || {});
        }
      } catch (err) {
        console.error('Dashboard load failed', err);
      }
    }

    function createRequest() {
      alert('Create request coming soon.');
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('userType');
      localStorage.removeItem('hospitalId');
      localStorage.removeItem('userName');
      window.location.href = '../login-hospital.html';
    }

    function setupSidebarToggle() {
      const sidebar = document.querySelector('.sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      if (!sidebar || !toggleBtn) return;

      const applyState = (collapsed) => {
        sidebar.classList.toggle('collapsed', collapsed);
        document.body.classList.toggle('sidebar-collapsed', collapsed);
      };

      const saved = localStorage.getItem('hospitalSidebarCollapsed') === 'true';
      applyState(saved);

      toggleBtn.addEventListener('click', () => {
        const next = !sidebar.classList.contains('collapsed');
        applyState(next);
        localStorage.setItem('hospitalSidebarCollapsed', String(next));
      });
    }

    function setupNav() {
      const pages = {
        dashboard: document.getElementById('dashboardPage'),
        history: document.getElementById('historyPage'),
        inventory: document.getElementById('inventoryPage'),
        donors: document.getElementById('donorsPage')
      };

      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          const page = item.dataset.page;
          if (!page) {
            // Let normal navigation occur for links to standalone pages
            return;
          }
          e.preventDefault();
          document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
          Object.keys(pages).forEach(key => {
            pages[key].classList.toggle('active', key === page);
          });
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupSidebarToggle();
      setupNav();
      loadDashboard();
    });
  </script>
</body>
</html>
